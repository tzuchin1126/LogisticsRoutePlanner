@* @{
    ViewData["Title"] = "資料欄位對應";
}

<h2>資料欄位對應</h2>

<form method="post" asp-action="ImportExcelConfirmed">
    <input type="hidden" name="shipmentId" value="@ViewBag.ShipmentId" />
    <input type="hidden" name="base64" value="@ViewBag.FileContent" />

    <div class="form-group">
        <label for="addressColumn">地址欄位</label>
        <select class="form-control" id="addressColumn" name="addressColumn">
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="nameColumn">客戶名稱欄位</label>
        <select class="form-control" id="nameColumn" name="nameColumn">
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="productColumn">商品欄位（可選）</label>
        <select class="form-control" id="productColumn" name="productColumn">
            <option value="">不使用</option>
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="noteColumn">備註欄位（可選）</label>
        <select class="form-control" id="noteColumn" name="noteColumn">
            <option value="">不使用</option>
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <button type="submit" class="btn btn-success">確認匯入</button>
</form> *@


@{
    ViewData["Title"] = "資料欄位對應";
    var headers = ViewBag.Headers as List<string> ?? new List<string>();
    var previewData = ViewBag.PreviewData as List<Dictionary<string, string>> ?? new List<Dictionary<string, string>>();
}

<div class="container-fluid py-3">
    <div class="row align-items-center mb-2">
        <div class="col">
            <h4 class="text-dark fw-bold m-0">資料欄位對應</h4>
            <small class="text-muted">請對應匯入資料中的欄位與系統需要的欄位，並確認預覽資料無誤後再送出。</small>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="post" asp-action="ImportExcelConfirmed">
                        <input type="hidden" name="shipmentId" value="@ViewBag.ShipmentId" />
                        <input type="hidden" name="base64" value="@ViewBag.FileContent" />

                        <!-- 資料欄位對應表單 -->
                        @foreach (var field in new[] { ("地址欄位", "addressColumn"), ("客戶名稱欄位", "nameColumn"), ("商品欄位", "productColumn"), ("備註欄位", "noteColumn") })
                        {
                            <div class="mb-3">
                                <label for="@field.Item2" class="form-label">@field.Item1 <span class="text-danger">*</span></label>
                                <select class="form-select preview-select" id="@field.Item2" name="@field.Item2" data-type="@field.Item2" required>
                                    <option disabled selected value="">請選擇欄位</option>
                                    @foreach (var header in headers)
                                    {
                                        <option value="@header">@header</option>
                                    }
                                </select>
                                <div class="form-text text-muted" id="preview-@field.Item2"></div>
                            </div>
                        }

                        <div class="text-end">
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="fas fa-check-circle me-1"></i> 確認匯入
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 預覽資料 -->
            <h5 class="mt-4">📋 預覽資料</h5>
            <div class="table-responsive border rounded">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        @if (previewData.Any())
                        {
                            <tr>
                                @foreach (var header in headers)
                                {
                                    <th>@header</th>
                                }
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="@headers.Count">無法載入預覽資料，請檢查檔案內容。</td>
                            </tr>
                        }
                    </thead>
                    <tbody>
                        @if (previewData.Any())
                        {
                            @foreach (var row in previewData)
                            {
                                <tr>
                                    @foreach (var header in headers)
                                    {
                                        <td>@(row.ContainsKey(header) ? row[header] : "")</td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="@headers.Count">無資料可顯示。</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const previewData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(previewData));

        function updatePreview(selectElement) {
            const columnName = selectElement.value;
            const type = selectElement.dataset.type;
            const previewId = "preview-" + type;

            if (!columnName || !previewData.length) {
                document.getElementById(previewId).textContent = "";
                return;
            }

            const sample = previewData
                .map(row => row[columnName] || "")
                .filter(x => x.trim() !== "")
                .slice(0, 3);

            document.getElementById(previewId).textContent = sample.length > 0
                ? `範例資料：${sample.join(" / ")}`
                : "無資料預覽";
        }

        // 初始化所有下拉選單預覽
        document.querySelectorAll(".preview-select").forEach(select => {
            select.addEventListener("change", () => updatePreview(select));
            updatePreview(select); // 預設顯示預覽
        });

        // 防止重複送出
        document.getElementById("submitBtn").addEventListener("click", function (e) {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> 匯入中...';
            this.form.submit();
        });
    </script>
}
