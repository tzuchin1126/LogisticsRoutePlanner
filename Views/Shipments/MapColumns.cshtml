@* @{
    ViewData["Title"] = "è³‡æ–™æ¬„ä½å°æ‡‰";
}

<h2>è³‡æ–™æ¬„ä½å°æ‡‰</h2>

<form method="post" asp-action="ImportExcelConfirmed">
    <input type="hidden" name="shipmentId" value="@ViewBag.ShipmentId" />
    <input type="hidden" name="base64" value="@ViewBag.FileContent" />

    <div class="form-group">
        <label for="addressColumn">åœ°å€æ¬„ä½</label>
        <select class="form-control" id="addressColumn" name="addressColumn">
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="nameColumn">å®¢æˆ¶åç¨±æ¬„ä½</label>
        <select class="form-control" id="nameColumn" name="nameColumn">
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="productColumn">å•†å“æ¬„ä½ï¼ˆå¯é¸ï¼‰</label>
        <select class="form-control" id="productColumn" name="productColumn">
            <option value="">ä¸ä½¿ç”¨</option>
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <div class="form-group">
        <label for="noteColumn">å‚™è¨»æ¬„ä½ï¼ˆå¯é¸ï¼‰</label>
        <select class="form-control" id="noteColumn" name="noteColumn">
            <option value="">ä¸ä½¿ç”¨</option>
            @foreach (var header in ViewBag.Headers)
            {
                <option value="@header">@header</option>
            }
        </select>
    </div>

    <button type="submit" class="btn btn-success">ç¢ºèªåŒ¯å…¥</button>
</form> *@


@{
    ViewData["Title"] = "è³‡æ–™æ¬„ä½å°æ‡‰";
    var headers = ViewBag.Headers as List<string> ?? new List<string>();
    var previewData = ViewBag.PreviewData as List<Dictionary<string, string>> ?? new List<Dictionary<string, string>>();
}

<div class="container-fluid py-3">
    <div class="row align-items-center mb-2">
        <div class="col">
            <h4 class="text-dark fw-bold m-0">è³‡æ–™æ¬„ä½å°æ‡‰</h4>
            <small class="text-muted">è«‹å°æ‡‰åŒ¯å…¥è³‡æ–™ä¸­çš„æ¬„ä½èˆ‡ç³»çµ±éœ€è¦çš„æ¬„ä½ï¼Œä¸¦ç¢ºèªé è¦½è³‡æ–™ç„¡èª¤å¾Œå†é€å‡ºã€‚</small>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="post" asp-action="ImportExcelConfirmed">
                        <input type="hidden" name="shipmentId" value="@ViewBag.ShipmentId" />
                        <input type="hidden" name="base64" value="@ViewBag.FileContent" />

                        <!-- è³‡æ–™æ¬„ä½å°æ‡‰è¡¨å–® -->
                        @foreach (var field in new[] { ("åœ°å€æ¬„ä½", "addressColumn"), ("å®¢æˆ¶åç¨±æ¬„ä½", "nameColumn"), ("å•†å“æ¬„ä½", "productColumn"), ("å‚™è¨»æ¬„ä½", "noteColumn") })
                        {
                            <div class="mb-3">
                                <label for="@field.Item2" class="form-label">@field.Item1 <span class="text-danger">*</span></label>
                                <select class="form-select preview-select" id="@field.Item2" name="@field.Item2" data-type="@field.Item2" required>
                                    <option disabled selected value="">è«‹é¸æ“‡æ¬„ä½</option>
                                    @foreach (var header in headers)
                                    {
                                        <option value="@header">@header</option>
                                    }
                                </select>
                                <div class="form-text text-muted" id="preview-@field.Item2"></div>
                            </div>
                        }

                        <div class="text-end">
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="fas fa-check-circle me-1"></i> ç¢ºèªåŒ¯å…¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- é è¦½è³‡æ–™ -->
            <h5 class="mt-4">ğŸ“‹ é è¦½è³‡æ–™</h5>
            <div class="table-responsive border rounded">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        @if (previewData.Any())
                        {
                            <tr>
                                @foreach (var header in headers)
                                {
                                    <th>@header</th>
                                }
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="@headers.Count">ç„¡æ³•è¼‰å…¥é è¦½è³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚</td>
                            </tr>
                        }
                    </thead>
                    <tbody>
                        @if (previewData.Any())
                        {
                            @foreach (var row in previewData)
                            {
                                <tr>
                                    @foreach (var header in headers)
                                    {
                                        <td>@(row.ContainsKey(header) ? row[header] : "")</td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="@headers.Count">ç„¡è³‡æ–™å¯é¡¯ç¤ºã€‚</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const previewData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(previewData));

        function updatePreview(selectElement) {
            const columnName = selectElement.value;
            const type = selectElement.dataset.type;
            const previewId = "preview-" + type;

            if (!columnName || !previewData.length) {
                document.getElementById(previewId).textContent = "";
                return;
            }

            const sample = previewData
                .map(row => row[columnName] || "")
                .filter(x => x.trim() !== "")
                .slice(0, 3);

            document.getElementById(previewId).textContent = sample.length > 0
                ? `ç¯„ä¾‹è³‡æ–™ï¼š${sample.join(" / ")}`
                : "ç„¡è³‡æ–™é è¦½";
        }

        // åˆå§‹åŒ–æ‰€æœ‰ä¸‹æ‹‰é¸å–®é è¦½
        document.querySelectorAll(".preview-select").forEach(select => {
            select.addEventListener("change", () => updatePreview(select));
            updatePreview(select); // é è¨­é¡¯ç¤ºé è¦½
        });

        // é˜²æ­¢é‡è¤‡é€å‡º
        document.getElementById("submitBtn").addEventListener("click", function (e) {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> åŒ¯å…¥ä¸­...';
            this.form.submit();
        });
    </script>
}
